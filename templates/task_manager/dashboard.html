{% extends 'base.html' %}
{% csrf_token %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="card create-task-card">
        <h3>Create New Task</h3>
        <form id="create-task-form">
            <div class="form-group">
                <label for="task-title">Title</label>
                <input type="text" id="task-title" required>
            </div>
            <div class="form-group">
                <label for="task-description">Description</label>
                <textarea id="task-description"></textarea>
            </div>
            <div class="form-group">
                <label for="assign-to">Assign To</label>
                <select id="assign-to" required>
                    <option value="">Loading users...</option>
                </select>
            </div>
            <button type="submit" class="btn">Create Task</button>
        </form>
        <p id="form-message" class="message"></p>
    </div>

    <div class="tasks-container">
        <div class="card task-list">
            <h3>My Tasks (Assigned to Me)</h3>
            <div id="my-tasks-list">
                <div class="loader">Loading tasks...</div>
            </div>
        </div>

        <div class="card task-list">
            <h3>Tasks I've Assigned</h3>
            <div id="assigned-tasks-list">
                 <div class="loader">Loading tasks...</div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const myTasksList = document.getElementById('my-tasks-list');
    const assignedTasksList = document.getElementById('assigned-tasks-list');
    const assignToSelect = document.getElementById('assign-to');
    const createTaskForm = document.getElementById('create-task-form');
    const formMessage = document.getElementById('form-message');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Fetch and display tasks
    async function fetchTasks() {
        myTasksList.innerHTML = '<div class="loader">Loading tasks...</div>';
        assignedTasksList.innerHTML = '<div class="loader">Loading tasks...</div>';

        try {
            const response = await fetch("{% url 'api_get_tasks' %}");
            if (!response.ok) throw new Error('Failed to fetch tasks');
            const data = await response.json();
            
            renderMyTasks(data.my_tasks);
            renderAssignedTasks(data.assigned_tasks);
        } catch (error) {
            console.error('Error fetching tasks:', error);
            myTasksList.innerHTML = '<p class="error" style="text-align:center;">Could not load your tasks.</p>';
            assignedTasksList.innerHTML = '<p class="error" style="text-align:center;">Could not load assigned tasks.</p>';
        }
    }

    // Fetch users for the assignment dropdown
    async function fetchUsers() {
        try {
            const response = await fetch("{% url 'api_get_users' %}");
            if (!response.ok) throw new Error('Failed to fetch users');
            const data = await response.json();

            assignToSelect.innerHTML = '<option value="">Select a user...</option>'; // Clear previous
            if (data.users.length === 0) {
                 assignToSelect.innerHTML = '<option value="">No users available to assign</option>';
            }
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                assignToSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching users:', error);
            assignToSelect.innerHTML = '<option value="">Could not load users</option>';
        }
    }

    function getStatusClass(status) {
        return 'status-' + status.toLowerCase().replace(' ', '-');
    }

    // Render "My Tasks"
    function renderMyTasks(tasks) {
        myTasksList.innerHTML = '';
        if (tasks.length === 0) {
            myTasksList.innerHTML = '<p style="text-align:center; color: #7f8c8d;">No tasks assigned to you.</p>';
            return;
        }
        tasks.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = `task-item ${getStatusClass(task.status)}`;
            taskElement.innerHTML = `
                <h4>${task.title}</h4>
                <p>${task.description || 'No description'}</p>
                <small>Assigned by: ${task.assigned_by__username}</small>
                <div class="status-updater">
                    <select class="status-select" data-task-id="${task.id}">
                        <option value="To Do" ${task.status === 'To Do' ? 'selected' : ''}>To Do</option>
                        <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                    </select>
                </div>
            `;
            myTasksList.appendChild(taskElement);

            // Add listener to update class on status change
            taskElement.querySelector('.status-select').addEventListener('change', function() {
                taskElement.className = `task-item ${getStatusClass(this.value)}`;
            });
        });
    }

    // Render "Tasks I've Assigned"
    function renderAssignedTasks(tasks) {
        assignedTasksList.innerHTML = '';
        if (tasks.length === 0) {
            assignedTasksList.innerHTML = '<p style="text-align:center; color: #7f8c8d;">You have not assigned any tasks.</p>';
            return;
        }
        tasks.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = `task-item ${getStatusClass(task.status)}`;
            taskElement.innerHTML = `
                <h4>${task.title}</h4>
                <p>${task.description || 'No description'}</p>
                <small>Assigned to: ${task.assigned_to__username}</small>
                <div class="task-status">Status: <strong>${task.status}</strong></div>
            `;
            assignedTasksList.appendChild(taskElement);
        });
    }
    
    // Handle status change for "My Tasks"
    myTasksList.addEventListener('change', async function(e) {
        if (e.target.classList.contains('status-select')) {
            const selectElement = e.target;
            const taskId = selectElement.dataset.taskId;
            const newStatus = selectElement.value;
            
            selectElement.style.borderColor = '#ddd';

            try {
                const response = await fetch(`/api/tasks/update/${taskId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update status');
                }
                
                // Refresh both lists to show updated status in real-time
                fetchTasks();
            } catch (error) {
                console.error('Error updating status:', error);
                // Visual feedback for error
                selectElement.style.borderColor = '#e74c3c';
                // Re-sync with the server after a moment to correct any optimistic UI changes
                setTimeout(fetchTasks, 1500);
            }
        }
    });

    // Handle create task form submission
    createTaskForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const assigned_to = assignToSelect.value;
        
        if (!assigned_to) {
            formMessage.textContent = 'Please select a user to assign the task to.';
            formMessage.className = 'message error';
            return;
        }

        try {
            const response = await fetch("{% url 'api_create_task' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ title, description, assigned_to })
            });

            const data = await response.json();
            
            if (!response.ok) {
                 throw new Error(data.error || 'Failed to create task');
            }

            formMessage.textContent = data.message;
            formMessage.className = 'message success';
            createTaskForm.reset();
            fetchTasks(); // Refresh lists
        } catch (error) {
            console.error('Error creating task:', error);
            formMessage.textContent = error.message;
            formMessage.className = 'message error';
        }
        
        setTimeout(() => {
             formMessage.textContent = '';
             formMessage.className = 'message';
        }, 3000);
    });

    // Initial data load
    fetchTasks();
    fetchUsers();
});
</script>
{% endblock %}

